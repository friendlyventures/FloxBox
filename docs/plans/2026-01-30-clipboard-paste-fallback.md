# Clipboard Paste Fallback Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Replace the buggy CGEvent Unicode fallback with a clipboard-swap + Cmd+V fallback that restores the clipboard when unchanged.

**Architecture:** Keep AX insertion as the primary path. When AX fails, use a new `ClipboardTextInserter` that snapshots the pasteboard, writes the transcript with transient/autogenerated/source markers, posts Cmd+V, then restores the original clipboard if the pasteboard change count is unchanged.

**Tech Stack:** Swift 6.2, AppKit, Carbon, NSPasteboard, Swift Package Manager

---

### Task 1: Add clipboard paste inserter

**Files:**
- Create: `Packages/FloxBoxCore/Sources/FloxBoxCore/Dictation/ClipboardTextInserter.swift`
- Test: `Packages/FloxBoxCore/Tests/FloxBoxCoreTests/ClipboardTextInserterTests.swift`

**Step 1: Write the failing test**

```swift
import AppKit
import XCTest
@testable import FloxBoxCore

final class ClipboardTextInserterTests: XCTestCase {
    func testInsertWritesTextAndRestoresWhenUnchanged() {
        let original = TestPasteboardItem(string: "original")
        let pasteboard = TestPasteboard(items: [original])
        let commandV = TestCommandVPaster(success: true)
        var scheduled: (() -> Void)?

        let inserter = ClipboardTextInserter(
            pasteboardProvider: { pasteboard },
            commandVPaster: commandV,
            restoreDelay: 0,
            restoreScheduler: { _, work in scheduled = work },
            sourceIdentifier: "com.test"
        )

        XCTAssertTrue(inserter.insert(text: "hello"))
        XCTAssertEqual(commandV.callCount, 1)
        XCTAssertEqual(pasteboard.stringValue, "hello")
        XCTAssertTrue(pasteboard.containsType("org.nspasteboard.TransientType"))
        XCTAssertTrue(pasteboard.containsType("org.nspasteboard.AutoGeneratedType"))
        XCTAssertEqual(pasteboard.stringValue(forType: "org.nspasteboard.source"), "com.test")

        scheduled?()
        XCTAssertEqual(pasteboard.stringValue, "original")
    }

    func testInsertSkipsRestoreWhenClipboardChanges() {
        let original = TestPasteboardItem(string: "original")
        let pasteboard = TestPasteboard(items: [original])
        let commandV = TestCommandVPaster(success: true)
        var scheduled: (() -> Void)?

        let inserter = ClipboardTextInserter(
            pasteboardProvider: { pasteboard },
            commandVPaster: commandV,
            restoreDelay: 0,
            restoreScheduler: { _, work in scheduled = work },
            sourceIdentifier: "com.test"
        )

        XCTAssertTrue(inserter.insert(text: "hello"))
        pasteboard.replace(with: TestPasteboardItem(string: "user"))
        scheduled?()

        XCTAssertEqual(pasteboard.stringValue, "user")
    }

    func testInsertRestoresImmediatelyWhenPasteFails() {
        let original = TestPasteboardItem(string: "original")
        let pasteboard = TestPasteboard(items: [original])
        let commandV = TestCommandVPaster(success: false)

        let inserter = ClipboardTextInserter(
            pasteboardProvider: { pasteboard },
            commandVPaster: commandV,
            restoreDelay: 0,
            restoreScheduler: { _, _ in XCTFail("restore should be immediate") },
            sourceIdentifier: "com.test"
        )

        XCTAssertFalse(inserter.insert(text: "hello"))
        XCTAssertEqual(pasteboard.stringValue, "original")
    }
}

private final class TestPasteboard: PasteboardAccessing {
    private(set) var changeCount: Int = 0
    private var items: [NSPasteboardItem]

    init(items: [NSPasteboardItem]) {
        self.items = items
    }

    var pasteboardItems: [NSPasteboardItem]? { items }

    func clearContents() {
        items = []
        changeCount += 1
    }

    @discardableResult
    func writeObjects(_ objects: [NSPasteboardWriting]) -> Bool {
        let newItems = objects.compactMap { $0 as? NSPasteboardItem }
        guard newItems.count == objects.count else { return false }
        items = newItems
        changeCount += 1
        return true
    }

    func replace(with item: NSPasteboardItem) {
        items = [item]
        changeCount += 1
    }

    var stringValue: String? {
        items.first?.string(forType: .string)
    }

    func stringValue(forType type: String) -> String? {
        items.first?.string(forType: NSPasteboard.PasteboardType(type))
    }

    func containsType(_ type: String) -> Bool {
        items.first?.types.contains(NSPasteboard.PasteboardType(type)) == true
    }
}

private final class TestPasteboardItem: NSPasteboardItem {
    init(string: String) {
        super.init()
        setString(string, forType: .string)
    }

    required init?(coder: NSCoder) {
        super.init(coder: coder)
    }
}

private struct TestCommandVPaster: CommandVPasting {
    let success: Bool
    private(set) var callCount: Int = 0

    mutating func postCommandV() -> Bool {
        callCount += 1
        return success
    }
}
```

**Step 2: Run test to verify it fails**

Run: `swift test --package-path Packages/FloxBoxCore --filter ClipboardTextInserterTests`
Expected: FAIL with missing types (`ClipboardTextInserter`, `PasteboardAccessing`, `CommandVPasting`).

**Step 3: Write minimal implementation**

`Packages/FloxBoxCore/Sources/FloxBoxCore/Dictation/ClipboardTextInserter.swift`:

```swift
import AppKit
import Carbon
import Foundation

public protocol PasteboardAccessing: AnyObject {
    var changeCount: Int { get }
    var pasteboardItems: [NSPasteboardItem]? { get }
    func clearContents()
    @discardableResult func writeObjects(_ objects: [NSPasteboardWriting]) -> Bool
}

extension NSPasteboard: PasteboardAccessing {}

public protocol CommandVPasting {
    mutating func postCommandV() -> Bool
}

public struct CGEventCommandVPaster: CommandVPasting {
    public init() {}

    public mutating func postCommandV() -> Bool {
        let keyCode = CGKeyCode(kVK_ANSI_V)
        guard let down = CGEvent(keyboardEventSource: nil, virtualKey: keyCode, keyDown: true),
              let up = CGEvent(keyboardEventSource: nil, virtualKey: keyCode, keyDown: false) else {
            return false
        }
        down.flags = .maskCommand
        up.flags = .maskCommand
        down.post(tap: .cghidEventTap)
        up.post(tap: .cghidEventTap)
        return true
    }
}

public final class ClipboardTextInserter: DictationTextInserting {
    private let pasteboardProvider: () -> PasteboardAccessing
    private var commandVPaster: CommandVPasting
    private let restoreDelay: TimeInterval
    private let restoreScheduler: (TimeInterval, @escaping () -> Void) -> Void
    private let sourceIdentifier: String

    public init(
        pasteboardProvider: @escaping () -> PasteboardAccessing = { NSPasteboard.general },
        commandVPaster: CommandVPasting = CGEventCommandVPaster(),
        restoreDelay: TimeInterval = 0.2,
        restoreScheduler: @escaping (TimeInterval, @escaping () -> Void) -> Void = { delay, work in
            DispatchQueue.main.asyncAfter(deadline: .now() + delay, execute: work)
        },
        sourceIdentifier: String = Bundle.main.bundleIdentifier ?? "FloxBox",
    ) {
        self.pasteboardProvider = pasteboardProvider
        self.commandVPaster = commandVPaster
        self.restoreDelay = restoreDelay
        self.restoreScheduler = restoreScheduler
        self.sourceIdentifier = sourceIdentifier
    }

    public func insert(text: String) -> Bool {
        guard !text.isEmpty else { return false }
        let pasteboard = pasteboardProvider()
        let originalItems = pasteboard.pasteboardItems ?? []

        let item = makePasteboardItem(text: text, source: sourceIdentifier)
        pasteboard.clearContents()
        guard pasteboard.writeObjects([item]) else { return false }
        let temporaryChangeCount = pasteboard.changeCount

        var poster = commandVPaster
        guard poster.postCommandV() else {
            restoreIfUnchanged(pasteboard: pasteboard, items: originalItems, changeCount: temporaryChangeCount)
            return false
        }

        restoreScheduler(restoreDelay) { [weak pasteboard] in
            guard let pasteboard else { return }
            restoreIfUnchanged(pasteboard: pasteboard, items: originalItems, changeCount: temporaryChangeCount)
        }
        return true
    }

    private func makePasteboardItem(text: String, source: String) -> NSPasteboardItem {
        let item = NSPasteboardItem()
        item.setString(text, forType: .string)
        item.setData(Data(), forType: NSPasteboard.PasteboardType("org.nspasteboard.TransientType"))
        item.setData(Data(), forType: NSPasteboard.PasteboardType("org.nspasteboard.AutoGeneratedType"))
        item.setString(source, forType: NSPasteboard.PasteboardType("org.nspasteboard.source"))
        return item
    }

    private func restoreIfUnchanged(
        pasteboard: PasteboardAccessing,
        items: [NSPasteboardItem],
        changeCount: Int
    ) {
        guard pasteboard.changeCount == changeCount else { return }
        pasteboard.clearContents()
        if !items.isEmpty {
            _ = pasteboard.writeObjects(items)
        }
    }
}
```

**Step 4: Run test to verify it passes**

Run: `swift test --package-path Packages/FloxBoxCore --filter ClipboardTextInserterTests`
Expected: PASS

**Step 5: Commit**

```bash
git add Packages/FloxBoxCore/Sources/FloxBoxCore/Dictation/ClipboardTextInserter.swift \
  Packages/FloxBoxCore/Tests/FloxBoxCoreTests/ClipboardTextInserterTests.swift
git commit -m "feat: add clipboard paste inserter"
```

---

### Task 2: Use clipboard paste fallback when AX fails

**Files:**
- Modify: `Packages/FloxBoxCore/Sources/FloxBoxCore/Dictation/DictationInjectionController.swift`

**Step 1: Write the failing test**

_No new test required (defaults wiring change only)._

**Step 2: Update default fallback inserter**

Change initializer default:

```swift
fallbackInserter: DictationTextInserting = ClipboardTextInserter(),
```

**Step 3: Run targeted tests**

Run: `swift test --package-path Packages/FloxBoxCore --filter DictationInjectionControllerTests`
Expected: PASS

**Step 4: Commit**

```bash
git add Packages/FloxBoxCore/Sources/FloxBoxCore/Dictation/DictationInjectionController.swift
git commit -m "feat: use clipboard paste fallback"
```
