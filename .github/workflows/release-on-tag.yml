name: Release on tag

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: false

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-stable:
    runs-on: self-hosted

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Sparkle
        env:
          SPARKLE_VERSION: 2.8.1
        run: |
          mkdir -p .action/sparkle
          cd .action/sparkle
          curl -L "https://github.com/sparkle-project/Sparkle/releases/download/${SPARKLE_VERSION}/Sparkle-for-Swift-Package-Manager.zip" > sparkle.zip
          unzip -q sparkle.zip
          echo "$(pwd)/bin" >> $GITHUB_PATH

      - name: Resolve version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "push" ]]; then
            VERSION="${GITHUB_REF#refs/tags/v}"
          elif [[ -n "${{ github.event.inputs.version }}" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="0.0.0-dev"
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Build number
        run: |
          echo "FLOXBOX_BUILD=$(git rev-list --count HEAD)" >> $GITHUB_ENV
          echo "FLOXBOX_COMMIT=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      - name: Build
        uses: ./.github/actions/build
        with:
          version: ${{ steps.version.outputs.version }}
          build_number: ${{ env.FLOXBOX_BUILD }}
          short_commit_hash: ${{ env.FLOXBOX_COMMIT }}
          feed_url: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/appcast.xml
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          INSTALLER_CERTIFICATE_BASE64: ${{ secrets.INSTALLER_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
          CERTIFICATE_NAME: ${{ secrets.CERTIFICATE_NAME }}
          INSTALLER_CERTIFICATE_NAME: ${{ secrets.INSTALLER_CERTIFICATE_NAME }}
          NOTARIZATION_APPLE_ID: ${{ secrets.NOTARIZATION_APPLE_ID }}
          NOTARIZATION_TEAM_ID: ${{ secrets.NOTARIZATION_TEAM_ID }}
          NOTARIZATION_PASS: ${{ secrets.NOTARIZATION_PASS }}
          SPARKLE_KEY_PUB: ${{ secrets.SPARKLE_KEY_PUB }}

      - name: Sign update
        env:
          SPARKLE_KEY: ${{ secrets.SPARKLE_KEY }}
        run: |
          set -euo pipefail
          echo "$SPARKLE_KEY" > signing.key
          SIGNATURE=$(sign_update -f signing.key floxbox-macos-universal.zip)
          rm -f signing.key
          if [[ -z "$SIGNATURE" ]]; then
            echo "Error: Failed to generate Sparkle signature" >&2
            exit 1
          fi
          if [[ ! "$SIGNATURE" =~ sparkle:edSignature= ]]; then
            echo "Error: Sparkle signature has invalid format: $SIGNATURE" >&2
            exit 1
          fi
          echo "SPARKLE_SIGNATURE=$SIGNATURE" >> $GITHUB_ENV

      - name: Generate stable appcast
        run: |
          set -euo pipefail
          PAGES_BASE_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}"
          VERSION="${{ steps.version.outputs.version }}"

          mkdir -p _site/beta

          if curl -fsSL "$PAGES_BASE_URL/beta/appcast.xml" -o _site/beta/appcast.xml; then
            echo "Preserved beta appcast."
          else
            echo "No beta appcast found (yet)."
          fi

          if curl -fsSL "$PAGES_BASE_URL/beta/floxbox-macos-universal.zip" -o _site/beta/floxbox-macos-universal.zip; then
            echo "Preserved beta zip."
          else
            echo "No beta zip found (yet)."
          fi

          cp floxbox-macos-universal.zip _site/

          DATE=$(date -R)
          STABLE_APPCAST_URL="$PAGES_BASE_URL/appcast.xml"
          STABLE_ZIP_URL="$PAGES_BASE_URL/floxbox-macos-universal.zip"

          {
            printf '%s\n' '<?xml version="1.0" encoding="utf-8"?>'
            printf '%s\n' '<rss version="2.0" xmlns:sparkle="http://www.andymatuschak.org/xml-namespaces/sparkle" xmlns:dc="http://purl.org/dc/elements/1.1/">'
            printf '%s\n' '  <channel>'
            printf '%s\n' '    <title>FloxBox Updates</title>'
            printf '%s\n' "    <link>${STABLE_APPCAST_URL}</link>"
            printf '%s\n' '    <description>FloxBox stable updates</description>'
            printf '%s\n' '    <language>en</language>'
            printf '%s\n' '    <item>'
            printf '%s\n' "      <title>FloxBox ${VERSION}</title>"
            printf '%s\n' "      <pubDate>${DATE}</pubDate>"
            printf '%s\n' "      <sparkle:version>${FLOXBOX_BUILD}</sparkle:version>"
            printf '%s\n' "      <sparkle:shortVersionString>${VERSION}</sparkle:shortVersionString>"
            printf '%s\n' '      <sparkle:minimumSystemVersion>14.6</sparkle:minimumSystemVersion>'
            printf '%s\n' "      <enclosure url=\"${STABLE_ZIP_URL}\" ${SPARKLE_SIGNATURE} type=\"application/octet-stream\"/>"
            printf '%s\n' '    </item>'
            printf '%s\n' '  </channel>'
            printf '%s\n' '</rss>'
          } > _site/appcast.xml

      - name: Ensure gtar
        run: |
          if ! command -v gtar >/dev/null 2>&1; then
            mkdir -p "$RUNNER_TEMP/gtar"
            cat > "$RUNNER_TEMP/gtar/gtar" <<'SH'
#!/usr/bin/env bash
exec /usr/bin/tar "$@"
SH
            chmod +x "$RUNNER_TEMP/gtar/gtar"
            echo "$RUNNER_TEMP/gtar" >> "$GITHUB_PATH"
          fi

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

  deploy-pages:
    needs: build-stable
    runs-on: self-hosted
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
